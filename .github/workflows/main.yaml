# .github/workflows/main.yml (ìµœì¢…)

name: CI/CD - Build and Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }} # DOCKERHUB_USERNAME ìœ¼ë¡œ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤
          password: ${{ secrets.DOCKERHUB_TOKEN }}    # DOCKERHUB_TOKEN ìœ¼ë¡œ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤
      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/crewai-app:latest # DOCKERHUB_USERNAME ìœ¼ë¡œ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤

  deploy:
    runs-on: self-hosted # <-- ðŸŒŸ ì´ í•œ ì¤„ë§Œ ubuntu-latestì—ì„œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!
    needs: build-and-push
    steps:
      - name: Check out the repo
        uses: actions/checkout@v3

      # self-hosted runnerëŠ” VM ìžì‹ ì—ê²Œ ëª…ë ¹ì„ ë‚´ë¦¬ëŠ” ê²ƒì´ë¯€ë¡œ
      # SSH, inventory ì„¤ì •ì´ ëª¨ë‘ í•„ìš” ì—†ìŠµë‹ˆë‹¤.
      - name: Run Ansible Playbook
        run: |
          pip install ansible
          ansible-playbook deploy.yml # -i ì˜µì…˜ë„ í•„ìš” ì—†ìŒ