# .github/workflows/main.yml (최종)

name: CI/CD - Build and Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }} # DOCKERHUB_USERNAME 으로 수정했습니다
          password: ${{ secrets.DOCKERHUB_TOKEN }}    # DOCKERHUB_TOKEN 으로 수정했습니다
      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/crewai-app:latest # DOCKERHUB_USERNAME 으로 수정했습니다

  deploy:
    runs-on: self-hosted # <-- 🌟 이 한 줄만 ubuntu-latest에서 변경되었습니다!
    needs: build-and-push
    steps:
      - name: Check out the repo
        uses: actions/checkout@v3

      # self-hosted runner는 VM 자신에게 명령을 내리는 것이므로
      # SSH, inventory 설정이 모두 필요 없습니다.
      - name: Run Ansible Playbook
        run: |
          pip install ansible
          ansible-playbook deploy.yml # -i 옵션도 필요 없음